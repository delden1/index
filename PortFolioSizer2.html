<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Options Trader Portfolio Optimizer</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --success-color: #27ae60;
            --success-dark: #219653;
            --danger-color: #c0392b;
            --danger-dark: #962d22;
            --light-bg: #ecf0f1;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--primary-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .main-wrapper {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- Header --- */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .header p { margin: 10px 0 0 0; opacity: 0.8; font-size: 0.9rem; }

        /* --- Top Section: Calculator --- */
        .calculator-container {
            background-color: #fff;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #eee;
        }

        .column {
            flex: 1 1 350px;
            padding: 30px;
        }

        .input-column {
            border-right: 1px solid #eee;
            background-color: #fbfbfb;
        }

        /* --- Input Styling --- */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary-color); }
        .input-wrapper { position: relative; }
        .input-prefix { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #7f8c8d; font-weight: bold; }
        input[type="number"] {
            width: 100%; padding: 12px 12px 12px 30px; border: 2px solid #bdc3c7;
            border-radius: 6px; font-size: 1rem; transition: border-color 0.3s; box-sizing: border-box;
        }
        input[type="number"]:focus { outline: none; border-color: var(--primary-color); }
        input:disabled { background-color: #e9ecef; cursor: not-allowed; }

        .helper-text { font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; font-style: italic; }

        .btn-add {
            width: 100%; padding: 15px; background-color: var(--secondary-color); color: white;
            border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s;
        }
        .btn-add:hover { background-color: var(--primary-color); }
        .btn-add:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* --- Output / Infographic Styling --- */
        .result-card {
            background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;
        }
        .result-card h3 { margin-top: 0; color: var(--secondary-color); font-size: 1.1rem; display: flex; justify-content: space-between; }
        .big-number { font-size: 1.5rem; font-weight: bold; }
        .profit-text { color: var(--success-color); }
        .loss-text { color: var(--danger-color); }

        .meter-container {
            height: 24px; background-color: #e0e0e0; border-radius: 12px; overflow: hidden; margin-top: 15px; position: relative;
        }
        .meter-fill { height: 100%; width: 0%; transition: width 0.5s ease-in-out; border-radius: 12px; }
        .meter-fill.profit { background: linear-gradient(90deg, var(--success-color), #2ecc71); }
        .meter-fill.loss { background: linear-gradient(90deg, var(--danger-color), #e74c3c); }
        .meter-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.85rem; font-weight: bold; color: #333; text-shadow: 0 0 2px rgba(255,255,255,0.8); white-space: nowrap;
        }

        /* --- Bottom Section: Portfolio Summary & Ledger --- */
        .portfolio-section {
            background-color: #fff; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: var(--card-shadow);
        }

        .summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .summary-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--secondary-color); }
        .summary-card h4 { margin: 0 0 10px 0; color: #7f8c8d; }
        .summary-val { font-size: 1.4rem; font-weight: bold; color: var(--primary-color); }

        /* --- Table Styling --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid #eee; }
        th { background-color: #f1f2f6; color: var(--secondary-color); }
        .status-active { background-color: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;}
        .status-won { background-color: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;}
        .status-lost { background-color: #ffebee; color: #c62828; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;}
        
        .btn-action { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-win { background-color: var(--success-color); color: white; }
        .btn-win:hover { background-color: var(--success-dark); }
        .btn-loss { background-color: var(--danger-color); color: white; }
        .btn-loss:hover { background-color: var(--danger-dark); }

        .error-message { color: var(--danger-color); margin-top: 10px; font-weight: bold; display: none; }

    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="header">
        <h1>Strategic Options Trader Portfolio Optimizer</h1>
        <p>Plan hypothetical trades, analyze risk against your compounded portfolio, and track performance with margin.</p>
    </div>

    <div class="calculator-container">
        <div class="column input-column">
            <div class="result-card" style="background: #eef2f7; border: none;">
                <h3 style="margin-bottom: 15px;">1. Portfolio Setup</h3>
                <div class="input-group">
                    <label for="initialCash">Initial Cash Deposit</label>
                    <div class="input-wrapper">
                        <span class="input-prefix">$</span>
                        <input type="number" id="initialCash" placeholder="e.g., 20000" min="1">
                    </div>
                    <p class="helper-text">Set this once to start. Buying power will be 1.5x this amount.</p>
                </div>
                 <button id="initializeBtn" class="btn-add" style="background-color: #7f8c8d; padding: 10px;">Set Initial Capital</button>
            </div>

            <div style="border-top: 2px dashed #ddd; margin: 30px 0;"></div>
            
            <h3 style="margin-bottom: 15px;">2. Stage New Trade Setup</h3>

            <div class="input-group">
                <label for="tradeMaxProfit">Trade Max Potential Profit</label>
                <div class="input-wrapper">
                    <span class="input-prefix">$</span>
                    <input type="number" id="tradeMaxProfit" placeholder="e.g., 500" min="0">
                </div>
            </div>

            <div class="input-group">
                <label for="tradeMaxLoss">Trade Max Defined Risk (Margin Req)</label>
                <div class="input-wrapper">
                    <span class="input-prefix">$</span>
                    <input type="number" id="tradeMaxLoss" placeholder="e.g., 200" min="0">
                </div>
                <p class="helper-text">The absolute max loss. This amount is locked against buying power.</p>
            </div>

            <div id="marginError" class="error-message">Error: Not enough buying power for this trade!</div>
            <button id="addTradeBtn" class="btn-add" disabled>+ Add Trade to Portfolio</button>
        </div>

        <div class="column output-column">
            <h3 style="margin-bottom: 20px;">Hypothetical Impact on *Current* Portfolio</h3>
            
             <div class="result-card" style="background-color: #f9f9f9;">
                <h3>Proposed R/R Ratio</h3>
                <p style="font-size: 1.1rem; margin: 10px 0;">For every $1 risked, you aim to make: <span id="rrRatioText" style="font-weight:bold;">$0.00</span></p>
            </div>

            <div class="result-card" style="border-left: 5px solid var(--danger-color);">
                <h3>
                    Risk Impact (Current Equity %)
                    <span id="riskPercText" class="big-number loss-text">0.00%</span>
                </h3>
                <div class="meter-container">
                    <div id="riskMeterFill" class="meter-fill loss"></div>
                    <span id="riskMeterLabel" class="meter-label">0%</span>
                </div>
                <p class="helper-text">Sizing based on current Net Cash.</p>
            </div>

            <div class="result-card" style="border-left: 5px solid var(--success-color);">
                <h3>
                    Reward Impact (Current Equity %)
                    <span id="rewardPercText" class="big-number profit-text">0.00%</span>
                </h3>
                <div class="meter-container">
                    <div id="rewardMeterFill" class="meter-fill profit"></div>
                    <span id="rewardMeterLabel" class="meter-label">0%</span>
                </div>
                 <p class="helper-text">Potential growth of current Net Cash.</p>
            </div>
            
            <p class="helper-text" style="text-align: center; margin-top: 20px;">Adjust inputs on the left to see how they affect your currently available capital before committing the trade.</p>

        </div>
    </div>

    <div class="portfolio-section">
        <h2>Portfolio Dashboard & Trade Ledger</h2>
        
        <div class="summary-grid">
            <div class="summary-card">
                <h4>Net Cash Balance</h4>
                <div class="summary-val" id="valNetCash">$0.00</div>
            </div>
            <div class="summary-card" style="border-left-color: #3498db;">
                <h4>Total Buying Power (1.5x Margin)</h4>
                <div class="summary-val" id="valTotalBP">$0.00</div>
            </div>
             <div class="summary-card" style="border-left-color: #e67e22;">
                <h4>Buying Power Used (Active Risk)</h4>
                <div class="summary-val" id="valUsedBP">$0.00</div>
            </div>
            <div class="summary-card" style="border-left-color: var(--success-color);">
                <h4>Available Buying Power</h4>
                <div class="summary-val" id="valAvailBP">$0.00</div>
            </div>
        </div>

        <h3>Active & Closed Trades</h3>
        <div class="table-container">
            <table id="tradeTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Max Profit Target</th>
                        <th>Max Risk Locked</th>
                        <th>R/R Ratio</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="noTradesRow"><td colspan="6" style="text-align: center; color: #999;">No trades added yet.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let portfolioState = {
        isInitialized: false,
        netCash: 0,
        totalBuyingPower: 0,
        usedBuyingPower: 0,
        tradeIdCounter: 1,
        trades: [] // Array of {id, maxProfit, maxRisk, status: 'active'|'won'|'lost'}
    };

    // --- DOM ELEMENTS ---
    const initialCashInput = document.getElementById('initialCash');
    const initializeBtn = document.getElementById('initializeBtn');
    const tradeMaxProfitInput = document.getElementById('tradeMaxProfit');
    const tradeMaxLossInput = document.getElementById('tradeMaxLoss');
    const addTradeBtn = document.getElementById('addTradeBtn');
    const marginError = document.getElementById('marginError');

    // Outputs related to hypothetical calc
    const rrRatioText = document.getElementById('rrRatioText');
    const riskPercText = document.getElementById('riskPercText');
    const riskMeterFill = document.getElementById('riskMeterFill');
    const riskMeterLabel = document.getElementById('riskMeterLabel');
    const rewardPercText = document.getElementById('rewardPercText');
    const rewardMeterFill = document.getElementById('rewardMeterFill');
    const rewardMeterLabel = document.getElementById('rewardMeterLabel');

    // Outputs related to portfolio summary
    const valNetCash = document.getElementById('valNetCash');
    const valTotalBP = document.getElementById('valTotalBP');
    const valUsedBP = document.getElementById('valUsedBP');
    const valAvailBP = document.getElementById('valAvailBP');
    const tradeTableBody = document.querySelector('#tradeTable tbody');
    const noTradesRow = document.getElementById('noTradesRow');

    // --- HELPER FUNCTIONS ---
    const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);

    // --- CORE LOGIC ---

    // 1. Initialize Portfolio
    initializeBtn.addEventListener('click', () => {
        const initCash = parseFloat(initialCashInput.value);
        if (isNaN(initCash) || initCash <= 0) {
            alert("Please enter a valid starting cash amount.");
            return;
        }

        portfolioState.netCash = initCash;
        // 50% margin means total buying power is 150% of cash (1.5x leverage)
        portfolioState.totalBuyingPower = initCash * 1.5; 
        portfolioState.isInitialized = true;

        // Lock initialization
        initialCashInput.disabled = true;
        initializeBtn.disabled = true;
        initializeBtn.textContent = "Portfolio Active";
        addTradeBtn.disabled = false;

        updatePortfolioSummaryUI();
        calculateHypothetical(); // Re-run hypothetical based on new cash
    });


    // 2. Hypothetical Calculator (Top Section)
    function calculateHypothetical() {
        if (!portfolioState.isInitialized) return;

        let maxProfit = parseFloat(tradeMaxProfitInput.value) || 0;
        let maxLoss = parseFloat(tradeMaxLossInput.value) || 0;

        maxProfit = Math.max(maxProfit, 0);
        maxLoss = Math.max(maxLoss, 0);

        // Sizing percentages are based on CURRENT NET CASH, not leveraged buying power.
        // Risking 5% of cash is different than risking 5% of buying power.
        const currentEquity = portfolioState.netCash;
        
        let riskPercentage = (currentEquity > 0) ? (maxLoss / currentEquity) * 100 : 0;
        let rewardPercentage = (currentEquity > 0) ? (maxProfit / currentEquity) * 100 : 0;
        let rrRatio = (maxLoss > 0) ? maxProfit / maxLoss : 0;

        // Update UI Text
        riskPercText.textContent = riskPercentage.toFixed(2) + '%';
        rewardPercText.textContent = rewardPercentage.toFixed(2) + '%';
        rrRatioText.textContent = '$' + rrRatio.toFixed(2);

        // Update Meters based on Net Cash impact
        const visualRiskWidth = Math.min(riskPercentage, 100);
        const visualRewardWidth = Math.min(rewardPercentage, 100);

        riskMeterFill.style.width = visualRiskWidth + '%';
        rewardMeterFill.style.width = visualRewardWidth + '%';
        riskMeterLabel.textContent = riskPercentage.toFixed(1) + '%';
        rewardMeterLabel.textContent = rewardPercentage.toFixed(1) + '%';

        // Visual Warning for high risk
        if (riskPercentage > 3.0) {
             riskPercText.style.fontWeight = '900'; riskPercText.style.color = "#e74c3c";
        } else {
             riskPercText.style.fontWeight = 'bold'; riskPercText.style.color = ""; // reset
        }

        // Margin Check Validation for the Add Button
        const availableBP = portfolioState.totalBuyingPower - portfolioState.usedBuyingPower;
        if (maxLoss > availableBP && maxLoss > 0) {
            marginError.style.display = 'block';
            addTradeBtn.disabled = true;
        } else {
            marginError.style.display = 'none';
             if(portfolioState.isInitialized) addTradeBtn.disabled = false;
        }
    }

    // Listen for inputs on hypothetical fields
    tradeMaxProfitInput.addEventListener('input', calculateHypothetical);
    tradeMaxLossInput.addEventListener('input', calculateHypothetical);


    // 3. Add Trade Logic
    addTradeBtn.addEventListener('click', () => {
        const maxProfit = parseFloat(tradeMaxProfitInput.value) || 0;
        const maxRisk = parseFloat(tradeMaxLossInput.value) || 0; // This is the margin requirement

        if (maxRisk <= 0 || maxProfit <= 0) {
             alert("Please enter valid profit and risk targets."); return;
        }

        // Final Margin Check before committing
        const availableBP = portfolioState.totalBuyingPower - portfolioState.usedBuyingPower;
        if (maxRisk > availableBP) {
            alert("Cannot add trade: Insufficient Buying Power."); return;
        }

        // Add to state
        portfolioState.trades.push({
            id: portfolioState.tradeIdCounter++,
            maxProfit: maxProfit,
            maxRisk: maxRisk,
            status: 'active'
        });

        // Update Used Buying Power
        portfolioState.usedBuyingPower += maxRisk;

        // Reset Inputs
        tradeMaxProfitInput.value = '';
        tradeMaxLossInput.value = '';

        updatePortfolioSummaryUI();
        renderTradeTable();
        calculateHypothetical(); // Reset meters
    });


    // 4. Close Trade Logic
    function closeTrade(tradeId, result) {
        const tradeIndex = portfolioState.trades.findIndex(t => t.id === tradeId);
        if (tradeIndex === -1) return;
        
        const trade = portfolioState.trades[tradeIndex];
        if (trade.status !== 'active') return; // Already closed

        // Update Trade Status
        trade.status = result === 'win' ? 'won' : 'lost';

        // Update Cash Balance based on result
        if (result === 'win') {
            portfolioState.netCash += trade.maxProfit;
        } else {
            portfolioState.netCash -= trade.maxRisk;
        }

        // Release Used Buying Power
        portfolioState.usedBuyingPower -= trade.maxRisk;

        // Recalculate Total Buying Power based on new Net Cash
        portfolioState.totalBuyingPower = portfolioState.netCash * 1.5;

        updatePortfolioSummaryUI();
        renderTradeTable();
        calculateHypothetical(); // Re-run hypothetical as the cash base has changed
    }


    // --- UI RENDERING FUNCTIONS ---

    function updatePortfolioSummaryUI() {
        valNetCash.textContent = formatCurrency(portfolioState.netCash);
        valTotalBP.textContent = formatCurrency(portfolioState.totalBuyingPower);
        valUsedBP.textContent = formatCurrency(portfolioState.usedBuyingPower);
        
        const availBP = portfolioState.totalBuyingPower - portfolioState.usedBuyingPower;
        valAvailBP.textContent = formatCurrency(availBP);
        
        // Color code available BP
        valAvailBP.style.color = availBP < (portfolioState.totalBuyingPower * 0.1) ? 'var(--danger-color)' : 'var(--success-color)';
    }

    function renderTradeTable() {
        // Clear current list except placeholder
        Array.from(tradeTableBody.children).forEach(child => {
            if (child.id !== 'noTradesRow') child.remove();
        });

        if (portfolioState.trades.length === 0) {
            noTradesRow.style.display = 'table-row';
            return;
        } else {
            noTradesRow.style.display = 'none';
        }

        // Populate backwards so newest is top
        [...portfolioState.trades].reverse().forEach(trade => {
            const row = document.createElement('tr');
            const rr = (trade.maxProfit / trade.maxRisk).toFixed(2);
            
            let statusHtml = '';
            let actionsHtml = '';

            if (trade.status === 'active') {
                statusHtml = '<span class="status-active">Active</span>';
                actionsHtml = `
                    <button class="btn-action btn-win" onclick="closeTrade(${trade.id}, 'win')">✓ Win</button>
                    <button class="btn-action btn-loss" onclick="closeTrade(${trade.id}, 'loss')">✗ Loss</button>
                `;
            } else if (trade.status === 'won') {
                statusHtml = '<span class="status-won">Closed (Won)</span>';
                actionsHtml = '<span style="color: var(--success-color);">+$' + trade.maxProfit + '</span>';
            } else {
                statusHtml = '<span class="status-lost">Closed (Lost)</span>';
                actionsHtml = '<span style="color: var(--danger-color);">-$' + trade.maxRisk + '</span>';
            }

            row.innerHTML = `
                <td>#${trade.id}</td>
                <td>${statusHtml}</td>
                <td>${formatCurrency(trade.maxProfit)}</td>
                <td>${formatCurrency(trade.maxRisk)}</td>
                 <td>1:${rr}</td>
                <td>${actionsHtml}</td>
            `;
            tradeTableBody.appendChild(row);
        });
    }

    // Initialize visual state
    calculateHypothetical();

</script>

</body>
</html>
